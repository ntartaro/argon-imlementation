<!DOCTYPE html>
<html dir="ltr" lang="en-US">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <link rel="stylesheet" href="/css/bootstrap.css" type="text/css" />
	<style style="text/css">
		.categories a {
			text-transform: capitalize;
		}
	</style>
</head>

<body style="padding-top:70px">
	<nav class="navbar navbar-default navbar-fixed-top">
	  <div class="container">
	    Vertex 360
	    <div id="btn-account-container">
	      <a class="btn btn-info" href="/me">My Account</a>
	    </div>
	  </div>
	</nav>

	<div class="row">

		<div class="col-md-2 col-md-offset-2">
			<h1>categories</h1>
			<hr />
			<ul class="categories">
				{{#categories}}
				<li><a class="category-link" href="#">{{.}}</a></li>
				{{/categories}}
			</ul>
		</div>

		<div class="col-md-4">
			<h1>templates</h1>
			<hr />
			<div id="templates"></div>
		</div>

    <div class="col-md-4">
			<h1>auth</h1>
			<hr />
      <form>
        <input id="input-register-name" type="text" placeholder="Name" name="name" /><br />
        <input id="input-register-email" type="text" placeholder="Email" name="email" /><br />
        <input id="input-register-pasword" type="password" placeholder="Password" name="password" /><br />
        <button id="btn-register">Register</button>
      </form>
      <br />

      <form>
        <input id="input-email" type="text" placeholder="Email" name="email" /><br />
        <input id="input-pasword" type="password" placeholder="Password" name="password" /><br />
        <button id="btn-login">Log In</button>
      </form>
		</div>

	</div>

	<script type="text/template" id="tpl-list-item-template">
		<li>
			<div>
          <a href="/template/<% slug %>">
					  <strong><% name %></strong>
          </a>
			</div>
		</li>
	</script>

	<script type="text/javascript">window.__PRELOADED_DATA__ = {{{preloaded}}}</script>
  <script type="text/javascript" src="/js/jquery.js"></script>
	<script type="text/javascript" src="/js/mustache.js"></script>
  <script type="text/javascript">
    (function(){
      Mustache.tags = ["<%", "%>"] // change delimiter so it doesn't conflict server side

      const data = window.__PRELOADED_DATA__
      const templates = data.templates
      var selected = data.selected
      var user = data.user

      if (user == null){
        $('#btn-account-container').html('')
        $('#btn-register').click(function(event){
          if (event)
            event.preventDefault()

          var visitor = {
            fullName: $('#input-register-name').val(),
            email: $('#input-register-email').val(),
            password: $('#input-register-pasword').val()
          }

          if (visitor.fullName.length == 0){
            alert('Please enter your NAME')
            return
          }

          if (visitor.email.length == 0){
            alert('Please enter your EMAIL')
            return
          }

          if (visitor.password.length == 0){
            alert('Please enter your PASSWORD')
            return
          }

          $.ajax({
            url: '/account/register',
            type: 'POST',
            data: visitor,
            success: function(response, status, xhr){
              if (response.confirmation != 'success'){
                alert('Error: ' + response.message)
    						return
    					}

              window.location.href = '/me'
            },
            error: function(xhr, status, err){
              alert('Error: ' + err.message)
            }
          })
        })

        $('#btn-login').click(function(event){
          if (event)
            event.preventDefault()

          var visitor = {
            email: $('#input-email').val(),
            password: $('#input-pasword').val()
          }

          if (visitor.email.length == 0){
            alert('Please enter your EMAIL')
            return
          }

          if (visitor.password.length == 0){
            alert('Please enter your PASSWORD')
            return
          }

          $.ajax({
            url: '/account/login',
            type: 'POST',
            data: visitor,
            success: function(response, status, xhr){
              if (response.confirmation != 'success'){
                alert('Error: ' + response.message)
    						return
    					}

              window.location.href = '/me'
            },
            error: function(xhr, status, err){
              alert('Error: ' + err.message)
            }
          })
        })
      }


      var fetchTemplates = function(category){
        $.ajax({
          url: '/api/site?template.status=live&template.category='+category,
          type: 'GET',
          data: null,
          success: function(response, status, xhr){
            if (response.confirmation != 'success'){
              alert(response.message)
              return
            }

            templates[category] = response.results
            reloadUI()
          },
          error: function(xhr, status, err){
            alert(err.message)
          }
        })
      }

      var reloadUI = function(){
        const templatesList = templates[selected]
        if (templatesList == null){
          fetchTemplates(selected)
          return
        }

        var html = '<ol>'
        var template = $('#tpl-list-item-template').html()
        templatesList.forEach(function(summary, i){
          html += Mustache.render(template, summary)
        })

        html += '</ol>'
        $('#templates').html(html)
      }

      $('.category-link').each(function(i, link){
        $(this).click(function(event){
          if (event)
            event.preventDefault()

          selected = $(this).html()
          reloadUI()
        })
      })

      reloadUI()
    })()

  </script>
</body>
</html>
